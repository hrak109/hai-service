events {}

http {
    upstream oakhillpines_api {
        server oakhillpines-api:8000;
        keepalive 32;
    }

    upstream private_api {
        server private-api:8001;
        keepalive 32;
    }

    upstream socius_api {
        server socius-api:8002;
        keepalive 32;
    }

    server {
        listen 80;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        
        ssl_certificate /etc/letsencrypt/live/api.oakhillpines.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/api.oakhillpines.com/privkey.pem;

        # Optional: Strong SSL Settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Optimization: Proxy buffer settings (optional but good for larger payloads)
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        location /api/oakhillpines/ {
            proxy_pass http://oakhillpines_api/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        location /api/private/ {
            proxy_pass http://private_api/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        location /api/socius/ {
            proxy_pass http://socius_api/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
}
